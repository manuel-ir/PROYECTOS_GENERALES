drop database if exists EJERCICIO4;
CREATE DATABASE EJERCICIO4;
USE EJERCICIO4;

CREATE TABLE TRABAJADOR (
    ID_T INT PRIMARY KEY,
    NOMBRE CHAR(20) NOT NULL,
    TARIFA REAL NOT NULL,
    OFICIO CHAR(15) NOT NULL,
    ID_SUPV INT NULL,
    CONSTRAINT fk_supervisor FOREIGN KEY (ID_SUPV) REFERENCES TRABAJADOR(ID_T)
);

CREATE TABLE EDIFICIO (
    ID_E INT NOT NULL PRIMARY KEY,
    DIR CHAR(15) NOT NULL,
    TIPO CHAR (10) NOT NULL,
    NIVEL_CALIDAD INT NOT NULL,
    CATEGORIA INT NOT NULL
);

CREATE TABLE ASIGNACION (
    ID_T INT NOT NULL,
    ID_E INT NOT NULL,
    FECHA_INICIO DATETIME NOT NULL,
    NUM_DIAS INT,
    PRIMARY KEY (ID_T, ID_E, FECHA_INICIO),
    CONSTRAINT fk_trabajador FOREIGN KEY (ID_T) REFERENCES TRABAJADOR(ID_T),
    CONSTRAINT fk_edificio FOREIGN KEY (ID_E) REFERENCES EDIFICIO(ID_E)
);


-- 2. INSERCIÓN DE DATOS
SET FOREIGN_KEY_CHECKS=0;

INSERT INTO TRABAJADOR VALUES (1235,"M. FARADAY",12.5,"ELECTRICISTA",1311);
INSERT INTO TRABAJADOR VALUES (1311,"C. COULOMB",15.5,"ELECTRICISTA",1311);
INSERT INTO TRABAJADOR VALUES (1412,"C. NEMO",13.75,"FONTANERO",1520);
INSERT INTO TRABAJADOR VALUES (1520,"H. RICKOVER",11.75,"FONTANERO",1520);
INSERT INTO TRABAJADOR VALUES (2920,"R. GARRET",10.0,"ALBAÑIL",2920);
INSERT INTO TRABAJADOR VALUES (3001,"J. BARRISTER",8.2,"CARPINTERO",3231);
INSERT INTO TRABAJADOR VALUES (3231,"P. MASON",17.4,"CARPINTERO",3231);

-- Actualizamos los supervisores que se auto-referencian (necesario)
UPDATE TRABAJADOR SET ID_SUPV = 2920 WHERE ID_T = 2920;
UPDATE TRABAJADOR SET ID_SUPV = 1520 WHERE ID_T = 1520;
UPDATE TRABAJADOR SET ID_SUPV = 1311 WHERE ID_T = 1311;
UPDATE TRABAJADOR SET ID_SUPV = 3231 WHERE ID_T = 3231;

SET FOREIGN_KEY_CHECKS=1;

INSERT INTO EDIFICIO VALUES (111,"1213 ASPEN","OFICINA",4,1);
INSERT INTO EDIFICIO VALUES (210,"1011 BIRCH","OFICINA",3,1);
INSERT INTO EDIFICIO VALUES (312,"123 ELM","OFICINA",2,2);
INSERT INTO EDIFICIO VALUES (435,"456 MAPLE","COMERCIO",1,1);
INSERT INTO EDIFICIO VALUES (460,"1415 BEACH","ALMACEN",3,3);
INSERT INTO EDIFICIO VALUES (515,"789 OAK","RESIDENCIA",3,2);

INSERT INTO ASIGNACION VALUES (1235,312,'2001-10-10',5);
INSERT INTO ASIGNACION VALUES (1235,515,'2001-10-17',22);
INSERT INTO ASIGNACION VALUES (1311,435,'2001-10-08',12);
INSERT INTO ASIGNACION VALUES (1311,460,'2001-10-23',24);
INSERT INTO ASIGNACION VALUES (1412,111,'2001-12-01',4);
INSERT INTO ASIGNACION VALUES (1412,210,'2001-11-15',12);
INSERT INTO ASIGNACION VALUES (1412,312,'2001-10-01',10);
INSERT INTO ASIGNACION VALUES (1412,435,'2001-10-15',15);
INSERT INTO ASIGNACION VALUES (1412,460,'2001-10-08',18);
INSERT INTO ASIGNACION VALUES (1412,515,'2001-11-05',8);
INSERT INTO ASIGNACION VALUES (1520,312,'2001-10-30',17);
INSERT INTO ASIGNACION VALUES (1520,515,'2001-10-09',14);
INSERT INTO ASIGNACION VALUES (2920,210,'2001-11-10',15);
INSERT INTO ASIGNACION VALUES (2920,435,'2001-10-28',10);
INSERT INTO ASIGNACION VALUES (2920,460,'2001-10-05',18);
INSERT INTO ASIGNACION VALUES (3001,111,'2001-10-08',14);
INSERT INTO ASIGNACION VALUES (3001,210,'2001-10-27',14);
INSERT INTO ASIGNACION VALUES (3231,111,'2001-10-10',8);
INSERT INTO ASIGNACION VALUES (3231,312,'2001-10-24',20);

-- 3. CREACIÓN DE PROCEDIMIENTOS ALMACENADOS (Necesarios para el Java)
DELIMITER //

-- a) Nombre de los trabajadores cuya tarifa este entre dos extremos.
CREATE PROCEDURE sp_consulta_a(IN min_tarifa DECIMAL(10, 2), IN max_tarifa DECIMAL(10, 2))
BEGIN
    SELECT NOMBRE, TARIFA FROM TRABAJADOR
    WHERE TARIFA BETWEEN min_tarifa AND max_tarifa
    ORDER BY NOMBRE;
END //

-- b) ¿Cuáles son los oficios de los trabajadores asignados un edificio?
CREATE PROCEDURE sp_consulta_b(IN id_edificio INT)
BEGIN
    SELECT DISTINCT T.OFICIO
    FROM TRABAJADOR T
    JOIN ASIGNACION A ON T.ID_T = A.ID_T
    WHERE A.ID_E = id_edificio;
END //

-- c) Indicar el nombre del trabajador y el de su supervisor.
CREATE PROCEDURE sp_consulta_c()
BEGIN
    SELECT T.NOMBRE AS Trabajador, S.NOMBRE AS Supervisor
    FROM TRABAJADOR T
    LEFT JOIN TRABAJADOR S ON T.ID_SUPV = S.ID_T;
END //

-- d) Nombre de los trabajadores asignados a oficinas.
CREATE PROCEDURE sp_consulta_d()
BEGIN
    SELECT DISTINCT T.NOMBRE
    FROM TRABAJADOR T
    JOIN ASIGNACION A ON T.ID_T = A.ID_T
    JOIN EDIFICIO E ON A.ID_E = E.ID_E
    WHERE E.TIPO = 'OFICINA';
END //

-- e) ¿Cuál es el número total de días que se han dedicado a una actividad (oficio)
--    en un edificio concreto?
CREATE PROCEDURE sp_consulta_e(IN oficio_act VARCHAR(100), IN id_edif INT)
BEGIN
    SELECT SUM(A.NUM_DIAS) AS Total_Dias
    FROM ASIGNACION A
    JOIN TRABAJADOR T ON A.ID_T = T.ID_T
    WHERE T.OFICIO = oficio_act AND A.ID_E = id_edif;
END //

-- f) ¿Cuántos tipos de oficios diferentes hay?
CREATE PROCEDURE sp_consulta_f()
BEGIN
    SELECT COUNT(DISTINCT OFICIO) AS Total_Oficios
    FROM TRABAJADOR;
END //

-- g) Para cada supervisor, ¿Cuál es la tarifa por hora más alta?
CREATE PROCEDURE sp_consulta_g()
BEGIN
    SELECT S.NOMBRE AS Supervisor, MAX(T.TARIFA) AS Tarifa_Max
    FROM TRABAJADOR T
    JOIN TRABAJADOR S ON T.ID_SUPV = S.ID_T
    GROUP BY S.NOMBRE;
END //

-- h) Para cada supervisor que supervisa a más de un trabajador,
--    ¿cuál es la tarifa más alta?
CREATE PROCEDURE sp_consulta_h()
BEGIN
    SELECT S.NOMBRE AS Supervisor, MAX(T.TARIFA) AS Tarifa_Max
    FROM TRABAJADOR T
    JOIN TRABAJADOR S ON T.ID_SUPV = S.ID_T
    GROUP BY S.NOMBRE
    HAVING COUNT(T.ID_T) > 1;
END //

-- i) ¿Qué trabajadores reciben una tarifa por hora menor que la del promedio?
CREATE PROCEDURE sp_consulta_i()
BEGIN
    SELECT NOMBRE, TARIFA
    FROM TRABAJADOR
    WHERE TARIFA < (SELECT AVG(TARIFA) FROM TRABAJADOR);
END //

-- j) ¿Qué trabajadores reciben una tarifa por hora menor que la del
--    promedio de los trabajadores que tienen su mismo oficio?
CREATE PROCEDURE sp_consulta_j()
BEGIN
    SELECT T.NOMBRE, T.OFICIO, T.TARIFA
    FROM TRABAJADOR T
    WHERE T.TARIFA < (
        SELECT AVG(T2.TARIFA)
        FROM TRABAJADOR T2
        WHERE T2.OFICIO = T.OFICIO
    );
END //

-- k) ¿Qué trabajadores reciben una tarifa por hora menor que la del
--    promedio de los trabajadores que dependen del mismo supervisor que él?
CREATE PROCEDURE sp_consulta_k()
BEGIN
    SELECT T.NOMBRE, T.ID_SUPV, T.TARIFA
    FROM TRABAJADOR T
    WHERE T.TARIFA < (
        SELECT AVG(T2.TARIFA)
        FROM TRABAJADOR T2
        WHERE T2.ID_SUPV = T.ID_SUPV
    );
END //

-- l) ¿Qué supervisores tienen trabajadores que tienen una tarifa por hora
--    encima un determinado valor?
CREATE PROCEDURE sp_consulta_l(IN min_tarifa_trabajador DECIMAL(10, 2))
BEGIN
    SELECT DISTINCT S.NOMBRE AS Supervisor
    FROM TRABAJADOR T
    JOIN TRABAJADOR S ON T.ID_SUPV = S.ID_T
    WHERE T.TARIFA > min_tarifa_trabajador;
END //

DELIMITER ;